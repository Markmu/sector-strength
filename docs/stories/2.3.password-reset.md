# Story 2.3: 密码重置功能

## Status
Backlog

## Story
**As a** 用户
**I want** 能够重置忘记的密码
**so that** 我可以重新获得对账户的访问权限

## Acceptance Criteria
1. ✅ 用户可以通过注册邮箱请求密码重置
2. ✅ 系统发送包含重置链接的邮件
3. ✅ 重置链接有有效期（1小时）
4. ✅ 重置链接只能使用一次
5. ✅ 用户可以设置新密码
6. ✅ 新密码必须满足密码强度要求
7. ✅ 重置成功后使所有现有会话失效
8. ✅ 防止通过重置链接获取用户信息
9. ✅ 请求频率限制防止滥用

## Tasks / Subtasks
### 后端实现
- [ ] 实现密码重置请求端点
  - [ ] POST /api/auth/password-reset-request
  - [ ] 验证邮箱是否存在
  - [ ] 生成安全的一次性重置令牌
  - [ ] 发送重置邮件
- [ ] 实现密码重置端点
  - [ ] POST /api/auth/password-reset
  - [ ] 验证重置令牌
  - [ ] 更新用户密码
  - [ ] 使所有现有JWT令牌失效
- [ ] 实现令牌管理
  - [ ] 存储重置令牌及其过期时间
  - [ ] 实现令牌失效机制
  - [ ] 清理过期令牌
- [ ] 安全措施
  - [ ] 请求速率限制（3次/小时/邮箱）
  - [ ] 令牌使用后立即失效
  - [ ] 防止令牌枚举攻击

### 前端实现
- [ ] 创建忘记密码页面
  - [ ] 输入邮箱表单
  - [ ] 提交按钮和加载状态
  - [ ] 成功/失败消息显示
- [ ] 创建密码重置页面
  - [ ] 重置令牌验证
  - [ ] 新密码输入和确认
  - [ ] 密码强度指示器
  - [ ] 表单验证
- [ ] 实现用户流程
  - [ ] 登录页面的"忘记密码"链接
  - [ ] 重置成功后跳转到登录页
  - [ ] 处理过期或无效令牌

### 邮件模板
- [ ] 设计重置邮件模板
  - [ ] 包含重置链接
  - [ ] 清晰的说明文字
  - [ ] 安全提示（如：从未请求请忽略）
- [ ] 邮件本地化支持
  - [ ] 支持中英文模板
  - [ ] 可配置的品牌元素

### 测试
- [ ] 单元测试：令牌生成/验证、密码更新
- [ ] 集成测试：完整重置流程
- [ ] 安全测试：令牌安全、速率限制、防止滥用

## Technical Requirements
- 重置令牌：使用UUID或加密的安全字符串
- 令牌有效期：1小时
- 邮件发送：异步处理
- 数据库：存储重置令牌哈希（非明文）
- API响应：不泄露邮箱是否存在的信息

## API Endpoints
```
POST /api/auth/password-reset-request
Request:
{
  "email": "user@example.com"
}

Response:
{
  "message": "If an account with this email exists, a password reset link has been sent."
}

POST /api/auth/password-reset
Request:
{
  "token": "uuid-token-here",
  "new_password": "NewSecurePass123!",
  "confirm_password": "NewSecurePass123!"
}

Response:
{
  "message": "Password has been reset successfully."
}
```

## Security Considerations
- 不在响应中透露邮箱是否存在
- 重置令牌应足够随机且不可预测
- 实施严格的速率限制
- 记录所有重置请求用于安全审计
- 考虑添加额外的安全验证（如安全问题）

## Dependencies
- 故事2.1完成（用户注册和邮箱验证）
- 故事2.2完成（用户登录）
- 邮件服务配置

## Notes
- 考虑添加管理员手动重置功能
- 可以添加密码重置通知邮件（告知用户密码已更改）
- 定期清理未使用的过期令牌

---
*Created: 2025-12-06*
*Author: Scrum Master*