# Story 9.6: 操作审计日志

## Status
Ready for Development

## Story
**As a** 系统管理员
**I want** 所有管理员操作被记录到审计日志
**so that** 可以追溯操作历史，满足合规要求和问题排查

## Acceptance Criteria
1. ✅ 记录所有管理员操作到审计日志（数据初始化、更新、用户管理）
2. ✅ 审计日志包含：操作人、操作时间、操作类型、操作内容、IP 地址、操作结果
3. ✅ 覆盖操作特别标注为"数据修正"
4. ✅ 审计日志支持查询（按用户、日期、操作类型筛选）
5. ✅ 审计日志支持导出（CSV 格式）
6. ✅ 审计日志保留至少 6 个月（自动清理旧数据）
7. ✅ 只有管理员可以查看审计日志
8. ✅ 审计日志本身不可修改（只读）

## Tasks / Subtasks
### 数据库设计
- [ ] 创建审计日志表（audit_logs）
  - [ ] id, user_id, action, resource_type, resource_id
  - [ ] details (JSONB), ip_address, user_agent
  - [ ] status, result, created_at
- [ ] 创建索引优化查询性能
- [ ] 创建自动清理旧数据的函数

### 后端实现
- [ ] 创建审计日志模型
  - [ ] `AuditLog` 模型
- [ ] 创建审计服务
  - [ ] `AuditService` 类
  - [ ] `log_action(user, action, details)` - 记录操作
  - [ ] `query_logs(filters)` - 查询日志
  - [ ] `export_logs(filters)` - 导出日志
- [ ] 创建审计装饰器
  - [ ] `@audit_log(action, resource_type)` - 自动记录操作
- [ ] 创建审计 API 端点
  - [ ] GET /api/admin/audit/logs - 获取审计日志（分页、筛选）
  - [ ] GET /api/admin/audit/logs/{id} - 获取日志详情
  - [ ] GET /api/admin/audit/export - 导出日志（CSV）

### 审计操作集成
- [ ] 数据初始化操作审计
  - [ ] Story 9.2：记录初始化操作
- [ ] 数据更新操作审计
  - [ ] Story 9.3：记录更新和覆盖操作
- [ ] 任务操作审计
  - [ ] Story 9.4：记录任务取消
- [ ] 用户管理操作审计
  - [ ] Story 9.5：记录角色变更

### 前端实现
- [ ] 创建审计日志查询面板
  - [ ] `AuditLogPanel` - 主面板
  - [ ] `AuditLogTable` - 日志列表表格
  - [ ] `AuditLogFilters` - 筛选器（用户、日期、操作类型）
  - [ ] `AuditLogDetail` - 日志详情（可展开）
- [ ] 导出功能按钮
- [ ] 日志详情查看（JSON 格式化显示）

### 自动清理
- [ ] 创建定期任务
  - [ ] 每周清理 6 个月前的日志
  - [ ] 保留前先备份到归档表（可选）

### 测试
- [ ] 单元测试：审计服务
- [ ] 集成测试：装饰器自动记录
- [ ] 测试：日志查询和筛选
- [ ] 测试：日志导出
- [ ] 测试：权限控制（只有管理员可查看）

## Technical Requirements
- 数据存储：JSONB 用于 details 字段
- 保留期限：6 个月
- 导出格式：CSV
- 查询性能：支持百万级记录查询 < 1 秒

## Database Schema
```sql
-- 审计日志表
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    username VARCHAR(100) NOT NULL,
    action VARCHAR(100) NOT NULL,  -- 操作类型：init_data, update_data, cancel_task, change_role, etc.
    resource_type VARCHAR(50),     -- 资源类型：sector, stock, task, user
    resource_id VARCHAR(100),      -- 资源 ID
    details JSONB,                 -- 操作详情（扩展字段）
    ip_address INET,
    user_agent TEXT,
    status VARCHAR(20) DEFAULT 'success',  -- success, failed, partial
    result TEXT,                   -- 操作结果描述
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);

-- 归档表（可选）
CREATE TABLE audit_logs_archive (
    LIKE audit_logs INCLUDING ALL
);

-- 自动清理函数
CREATE OR REPLACE FUNCTION cleanup_old_audit_logs()
RETURNS void AS $$
BEGIN
    -- 移动到归档表（可选）
    INSERT INTO audit_logs_archive
    SELECT * FROM audit_logs
    WHERE created_at < NOW() - INTERVAL '6 months';

    -- 删除旧数据
    DELETE FROM audit_logs
    WHERE created_at < NOW() - INTERVAL '6 months';
END;
$$ LANGUAGE plpgsql;
```

## API Endpoints
| Method | Endpoint | Query Params | Description |
|--------|----------|--------------|-------------|
| GET | /api/admin/audit/logs | userId, action, resourceType, startDate, endDate, page, pageSize | 获取审计日志 |
| GET | /api/admin/audit/logs/{id} | - | 获取日志详情 |
| GET | /api/admin/audit/export | userId, action, startDate, endDate | 导出日志（CSV） |

## Audit Actions
| Action | 描述 | 资源类型 |
|--------|------|----------|
| `sectors.init` | 初始化板块数据 | sector |
| `stocks.init` | 初始化股票数据 | stock |
| `data.backfill` | 按日期补齐数据 | data |
| `data.backfill_range` | 按时间段补齐 | data |
| `data.overwrite` | 覆盖数据 | data |
| `task.cancel` | 取消任务 | task |
| `user.role_change` | 修改用户角色 | user |
| `user.disable` | 禁用用户 | user |

## Response Examples
### 审计日志列表
```json
{
  "logs": [
    {
      "id": 1,
      "userId": 1,
      "username": "admin",
      "action": "stocks.init",
      "resourceType": "stock",
      "resourceId": "task_abc123",
      "details": {
        "days": 60,
        "overwrite": false,
        "estimatedStocks": 5000
      },
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "status": "success",
      "result": "初始化任务已创建",
      "createdAt": "2025-12-24T10:00:00Z"
    },
    {
      "id": 2,
      "userId": 1,
      "username": "admin",
      "action": "data.overwrite",
      "resourceType": "stock",
      "resourceId": "600000",
      "details": {
        "startDate": "2025-12-01",
        "endDate": "2025-12-24",
        "reason": "数据异常修正"
      },
      "ipAddress": "192.168.1.100",
      "status": "success",
      "result": "已覆盖 24 条记录",
      "createdAt": "2025-12-24T11:00:00Z"
    }
  ],
  "total": 156,
  "page": 1,
  "pageSize": 20
}
```

## Decorator Usage
```python
from server.src.services.audit import AuditService, audit_log

# 方式1：使用装饰器
@audit_log(action="user.role_change", resource_type="user")
def change_user_role(user_id: int, new_role: str):
    # 更新用户角色
    pass

# 方式2：手动记录
AuditService.log_action(
    user=current_user,
    action="data.overwrite",
    resource_type="stock",
    resource_id=stock_code,
    details={
        "startDate": str(start_date),
        "endDate": str(end_date),
        "overwrite": True
    },
    status="success",
    result=f"已覆盖 {count} 条记录"
)
```

## Frontend Component
### 审计日志面板
```
┌────────────────────────────────────────────────────────────────┐
│  审计日志                                                        │
├────────────────────────────────────────────────────────────────┤
│  [筛选器]                                                       │
│  用户: [全部▼]  操作: [全部▼]  日期: [从_____ 到_____]         │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ 时间         │ 操作人   │ 操作类型       │ 资源   │ 状态  │ │
│  ├──────────────────────────────────────────────────────────┤ │
│  │ 12-24 11:00 │ admin    │ stocks.init    │ -      │ ✓成功 │ │
│  │ 12-24 10:30 │ admin    │ data.overwrite │ 600000 │ ✓成功 │ │
│  │ 12-24 10:00 │ admin    │ task.cancel    │ abc123 │ ✓成功 │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
│  [导出 CSV]  [查看详情]                                         │
└────────────────────────────────────────────────────────────────┘
```

## Dependencies
- Story 9.1（管理员权限）
- Story 9.2, 9.3, 9.4, 9.5（被审计的操作）

## Definition of Done
- [ ] 所有验收标准完成
- [ ] 审计日志表创建成功
- [ ] 所有管理员操作集成审计日志
- [ ] 查询和导出功能完成
- [ ] 自动清理任务配置完成
- [ ] 权限测试通过（只有管理员可查看）
- [ ] API 文档更新

## Compliance Notes
- 审计日志满足金融科技合规要求
- 支持事后追溯和责任认定
- 数据修正操作特别标注
- 日志保留 6 个月符合基本要求

## Risk Assessment
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 日志数据量大 | 存储压力 | 定期清理 + 归档 |
| 查询性能下降 | 响应慢 | 索引优化 + 分页 |
| 日志丢失 | 无法追溯 | 归档表备份 |

## Notes
- 考虑未来扩展：日志分析仪表板
- 可以考虑集成到 SIEM 系统（如 Splunk）
- 敏感操作（如覆盖数据）应发送告警

## File List
### 新增文件
- `server/src/models/audit_log.py` - 审计日志模型
- `server/src/services/audit.py` - 审计服务
- `server/src/api/admin/audit.py` - 审计 API 端点
- `server/alembic/versions/xxx_create_audit_logs_table.py` - 数据库迁移
- `web/src/components/admin/panels/AuditLogPanel.tsx` - 审计日志面板

---
*Created: 2025-12-24*
*Author: PM Agent (John)*
*Priority: P1*
*Estimate: 2 天*
