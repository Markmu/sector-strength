# Story 1.2: 数据库架构设计

## Status
Ready for Review

## Story
**As a** 系统架构师
**I want** 设计良好的数据库schema
**so that** 系统能够高效存储和查询股票板块数据

## Acceptance Criteria
1. ✅ PostgreSQL数据库容器化部署
2. ✅ 股票数据表结构设计完成
3. ✅ 板块信息表结构设计完成
4. ✅ 强度得分计算相关表设计
5. ✅ 索引优化策略制定
6. ✅ 迁移脚本准备
7. ✅ 数据库连接配置验证

## Tasks / Subtasks
- [x] 设计数据库schema
  - [x] 股票基本信息表 (src/models/stock.py)
  - [x] 板块分类表 (src/models/sector.py)
  - [x] 历史价格数据表 (src/models/daily_market_data.py)
  - [x] 强度得分表 (src/models/strength_score.py)
  - [x] 均线数据表 (src/models/moving_average_data.py)
  - [x] 周期配置表 (src/models/period_config.py)
  - [x] 板块股票关联表 (src/models/sector_stock.py)
- [x] 创建迁移脚本
  - [x] 使用Alembic工具 (server/alembic/)
  - [x] 版本化迁移管理
  - [x] 基础连接和同步配置
- [x] 配置数据库连接
  - [x] 环境变量配置 (server/src/config.py)
  - [x] 连接池设置
  - [x] 错误处理机制
- [x] 数据库约束优化
  - [x] 移除不必要的约束
  - [x] 优化索引结构
  - [x] 提升系统灵活性

## Dev Notes
### 相关架构信息
- **数据库**: PostgreSQL 14+
- **ORM**: 可能使用SQLAlchemy或类似
- **数据源**: AkShare金融数据接口
- **数据特性**: 时间序列数据，需要高效查询

### 表结构设计要点
- 股票表: 代码、名称、所属板块等
- 板块表: 板块代码、名称、行业分类
- 价格表: 时间戳、开盘价、收盘价、成交量等
- 强度表: 计算时间、各周期强度得分

### 测试标准
- 数据库连接测试
- 基本CRUD操作验证
- 查询性能测试
- 迁移脚本回滚测试

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-21 | v1.0 | 初始故事创建 | PO Agent |
| 2025-09-23 | v1.1 | 移除种子数据和备份策略任务 | PO Agent |

## Dev Agent Record
### Agent Model Used
Developer Agent (Amelia) - Claude Code

### Debug Log References
无严重错误，主要优化了约束和索引定义语法

### Completion Notes List
- 完成了所有数据库模型的设计和实现
- 创建了7个核心数据表模型
- 配置了Alembic数据库迁移工具
- 优化了数据库约束，移除不必要的限制
- 修复了索引定义中的语法错误
- 所有测试用例通过验证

### File List
- `server/src/models/__init__.py` - 模型导入配置
- `server/src/models/stock.py` - 股票模型
- `server/src/models/sector.py` - 板块模型
- `server/src/models/daily_market_data.py` - 日线行情数据模型
- `server/src/models/strength_score.py` - 强度得分模型
- `server/src/models/moving_average_data.py` - 均线数据模型
- `server/src/models/period_config.py` - 周期配置模型
- `server/src/models/sector_stock.py` - 板块-股票关联模型
- `server/src/db/database.py` - 数据库连接配置
- `server/src/db/sync_database.py` - 同步数据库配置
- `server/alembic.ini` - Alembic配置文件
- `server/alembic/env.py` - Alembic环境配置
- `server/tests/test_strength_score_model.py` - 强度得分模型测试
- `docs/database-optimization-report.md` - 数据库优化报告

## QA Results
