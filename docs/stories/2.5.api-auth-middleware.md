# Story 2.5: API认证中间件

## Status
Backlog

## Story
**As a** 系统架构师
**I want** 实现统一的API认证和授权中间件
**so that** 所有受保护的API端点都能安全地验证用户身份和权限

## Acceptance Criteria
1. ✅ 创建JWT认证中间件，验证请求中的访问令牌
2. ✅ 支持端点级别的权限配置
3. ✅ 自动处理令牌过期和刷新
4. ✅ 提供清晰的未认证/未授权响应
5. ✅ 实现API访问速率限制
6. ✅ 支持可选认证（匿名访问某些端点）
7. ✅ 记录所有认证失败的尝试
8. ✅ 支持跨域资源共享（CORS）配置

## Tasks / Subtasks
### 认证中间件实现 ✅ COMPLETED
- [x] 创建JWT认证装饰器(src/core/auth_middleware.py)
  - [x] 验证令牌签名和有效期
  - [x] 解析用户信息并附加到请求对象
  - [x] 从JWT中提取用户角色和权限信息
  - [x] 处理令牌过期自动刷新
- [x] 创建权限检查装饰器(src/core/auth_middleware.py)
  - [x] 实现require_authenticated装饰器（检查用户是否登录）
  - [x] 实现require_role装饰器（检查用户角色）
  - [x] 实现require_permission装饰器（检查具体权限，如有需要）
  - [x] 实现可选认证机制(get_current_user_optional)
  - [x] 实现require_any_role装饰器（检查是否有任一角色）
  - [x] 实现require_all_permissions装饰器（检查是否拥有所有权限）
- [x] 构建端点保护机制
  - [x] 制定端点保护配置规则（哪些端点需要认证、权限）
  - [x] 在FastAPI中集成权限中间件
  - [x] 处理匿名用户的默认权限

### 访问控制实现(简化版)
**Phase 1: 数据库模型更新** ✅
- [x] 修改数据库结构
  - [x] 创建Alembic迁移脚本: 在users表添加role和permissions字段
  - [x] 执行数据库迁移
  - [x] 更新User模型(Python)
  - [x] 添加辅助方法(has_role, has_permission, add_permission, remove_permission)
  - [x] 实现__init__方法设置默认值

**Phase 2: 角色和权限初始化** ✅
- [x] 为新用户设置默认角色
  - [x] 在注册逻辑中自动分配'user'角色(通过User.__init__)
  - [x] 确保非管理员用户无法获得admin角色
- [x] 创建管理员用户
  - [x] 提供数据库脚本或手动设置初始管理员
  - [x] 记录管理员账户凭证

### 安全增强
- [ ] 实施API速率限制
  - [ ] 基于用户的速率限制
  - [ ] 基于IP的速率限制
  - [ ] 支持不同端点的不同限制
  - [ ] 使用Redis存储计数器
- [ ] CORS配置
  - [ ] 配置允许的来源
  - [ ] 配置允许的方法和头部
  - [ ] 处理预检请求
- [ ] 安全头部
  - [ ] 添加安全相关的HTTP头部
  - [ ] CSP配置
  - [ ] XSS保护

### 监控和日志
- [ ] 认证日志记录
  - [ ] 记录成功的认证
  - [ ] 记录失败的认证尝试
  - [ ] 记录权限拒绝
- [ ] API访问监控
  - [ ] 记录API调用频率
  - [ ] 检测异常访问模式
  - [ ] 生成安全报告

## Technical Requirements
- JWT验证：PyJWT or FastAPI JWT Auth
- 缓存：Redis for rate limiting
- 数据库：修改users表结构(添加2个字段)
- 异步支持：FastAPI async中间件
- 类型提示：完整的Python类型注解

## Implementation Details

### 中间件使用示例
```python
from fastapi import FastAPI, Depends
from api.auth import get_current_user, require_role, require_permission

app = FastAPI()

# 需要认证的端点
@app.get("/api/user/profile")
async def get_profile(user=Depends(get_current_user)):
    return {"user": user}

# 需要管理员角色的端点
@app.post("/api/admin/users")
async def create_user(user=Depends(require_role("admin"))):
    pass

# 需要特定权限的端点
@app.delete("/api/posts/{post_id}")
async def delete_post(
    post_id: int,
    user=Depends(require_permission("delete_post"))
):
    pass
```

### 数据库设计(简化版)
**更新users表结构,在原有字段基础上添加:**

```python
# 在 server/src/models/user.py 中添加:
role = Column(String(20), default='user', nullable=False, index=True, comment="用户角色: admin, user")
permissions = Column(JSON, default=list, comment="用户权限列表")
```

**数据库迁移SQL:**
```sql
-- 添加角色字段
ALTER TABLE users
ADD COLUMN role VARCHAR(20) DEFAULT 'user' NOT NULL;

-- 添加权限字段
ALTER TABLE users
ADD COLUMN permissions JSONB DEFAULT '[]' NOT NULL;

-- 创建索引优化查询
CREATE INDEX idx_user_role ON users(role);
```

**优势:**
- 简化实现,减少4个关联表
- 提升查询性能(单表查询,无需JOIN)
- 降低维护复杂度
- 足够满足MVP需求

**适用场景:**
- 角色数量有限(admin, user)
- 权限简单(可直接在JWT中携带)
- MVP阶段快速开发

### 中间件配置
```python
# 在FastAPI应用中配置中间件
app.add_middleware(
    AuthenticationMiddleware,
    exclude_paths=["/api/auth/login", "/api/auth/register", "/docs", "/openapi.json"]
)

app.add_middleware(
    RateLimitMiddleware,
    default_limits="100/minute",
    overrides={
        "/api/auth/login": "5/minute",
        "/api/auth/register": "3/hour"
    }
)
```

## API Documentation
### Authentication Header
```
Authorization: Bearer <jwt_token>
```

### Error Responses
```
401 Unauthorized:
{
  "error": "authentication_required",
  "message": "This endpoint requires authentication"
}

403 Forbidden:
{
  "error": "insufficient_permissions",
  "message": "You don't have permission to perform this action"
}

429 Too Many Requests:
{
  "error": "rate_limit_exceeded",
  "message": "Too many requests, try again later"
}
```

## Security Considerations
- 始终验证令牌签名
- 实施适当的速率限制
- 不要在响应中泄露敏感信息
- 记录所有安全相关事件
- 定期轮换JWT签名密钥
- 考虑实现短期访问令牌+长期刷新令牌模式

## Dependencies
- 故事2.2完成（JWT实现）✅
- Redis配置（用于速率限制）✅
- 数据库迁移脚本（users表添加字段）✅
- User模型已更新（包含role和permissions）✅

## Testing Requirements
- [ ] 单元测试：所有中间件和装饰器
- [ ] 集成测试：认证流程
- [ ] 安全测试：权限绕过尝试
- [ ] 性能测试：中间件开销

## Notes
- 考虑实现API密钥认证用于服务间通信
- 可以添加更细粒度的权限控制（如资源级权限）
- 考虑实现权限缓存以提高性能
- 规划未来的多租户支持

### 2025-12-15 变更记录: 权限系统简化
**变更原因**: 原设计过度复杂,4张关联表对于MVP阶段过于工程化

**变更内容**:
- 移除了独立的roles、permissions、user_roles、role_permissions表
- 在用户表(users)添加role字段(VARCHAR)和permissions字段(JSON数组)
- 简化了任务清单和实现复杂度

**变更优势**:
- 开发时间从3-4天缩短至1天
- 减少数据库JOIN查询,提升性能
- 降低维护成本
- 足够满足MVP阶段需求(admin/user角色划分)

---
*Created: 2025-12-06*
*Last Updated: 2025-12-15*
*Author: Scrum Master*