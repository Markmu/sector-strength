# Story 10.6: 自定义权重配置（可选）

Status: todo

## Story

作为一名 高级用户，
我需要 创建和管理自定义的强度计算权重配置，
以便 根据个人投资偏好调整强度计算方法，获得更符合个人需求的强度评分。

## Acceptance Criteria

1. ✅ 实现权重配置管理功能（创建、编辑、删除、查询）
2. ✅ 实现预设配置模板（保守型、平衡型、激进型）
3. ✅ 实现配置导入导出功能（JSON 格式）
4. ✅ 实现配置验证和合理性检查
5. ✅ 支持使用自定义配置进行强度计算
6. ✅ 实现配置推荐功能（基于历史回测）
7. ✅ 实现配置共享功能（可选）
8. ✅ 添加完整的单元测试和集成测试

## Tasks / Subtasks

### 1. 权重配置数据模型 (AC: 1, 4)

- [ ] 更新 `server/src/models/` 创建新表
  - [ ] 创建 `server/src/models/weight_config.py`
    - [ ] 定义 `WeightConfig` 表
      - [ ] id (主键)
      - [ ] name (配置名称)
      - [ ] description (描述)
      - [ ] user_id (用户ID，NULL表示系统预设)
      - [ ] is_active (是否激活)
      - [ ] is_public (是否公开共享)
      - [ ] config_data (JSON，存储权重配置)
      - [ ] backtest_results (JSON，回测结果)
      - [ ] created_at, updated_at
    - [ ] 添加索引
    - [ ] 添加约束
  - [ ] 创建 Alembic 迁移脚本

### 2. 权重配置 Schema 定义 (AC: 1)

- [ ] 创建 `server/src/api/schemas/weight_config.py`
  - [ ] 定义 `WeightConfigBase` Schema
    - [ ] name, description
    - [ ] 权重配置字段
  - [ ] 定义 `WeightConfigCreate` Schema
    - [ ] 权重验证规则
    - [ ] 权重总和检查（=1.0）
  - [ ] 定义 `WeightConfigUpdate` Schema
  - [ ] 定义 `WeightConfigResponse` Schema
  - [ ] 定义 `WeightConfigListResponse` Schema
  - [ ] 定义 `WeightConfigImportExport` Schema

### 3. 权重配置服务 (AC: 1, 4)

- [ ] 创建 `server/src/services/weight_config_service.py`
  - [ ] 实现 `create_config(user_id: int, config_data: Dict) -> Dict`
    - [ ] 验证权重配置
    - [ ] 检查权重总和
    - [ ] 保存到数据库
    - [ ] 返回完整配置
  - [ ] 实现 `update_config(config_id: int, user_id: int, config_data: Dict) -> Dict`
    - [ ] 权限验证
    - [ ] 更新配置
  - [ ] 实现 `delete_config(config_id: int, user_id: int) -> bool`
    - [ ] 权限验证
    - [ ] 检查是否为系统预设（不可删除）
  - [ ] 实现 `get_config(config_id: int) -> Dict`
  - [ ] 实现 `list_configs(user_id: int, include_public: bool) -> List`
  - [ ] 实现 `set_active_config(config_id: int, user_id: int) -> Dict`

### 4. 预设配置模板 (AC: 2)

- [ ] 创建 `server/src/config/weight_presets.py`
  - [ ] 定义 `CONSERVATIVE_PRESET`（保守型）
    - [ ] 价格位置权重：40%
    - [ ] 均线排列权重：60%（更注重趋势）
    - [ ] 中长期均线权重更高
  - [ ] 定义 `BALANCED_PRESET`（平衡型）
    - [ ] 价格位置权重：50%
    - [ ] 均线排列权重：50%（系统默认）
  - [ ] 定义 `AGGRESSIVE_PRESET`（激进型）
    - [ ] 价格位置权重：60%
    - [ ] 均线排列权重：40%（更注重短期）
    - [ ] 短期均线权重更高
  - [ ] 定义 `MOMENTUM_PRESET`（动量型）
    - [ ] 短期均线权重极高
    - [ ] 价格突变敏感度更高
  - [ ] 实现预设配置初始化脚本

### 5. 配置导入导出 (AC: 3)

- [ ] 创建 `server/src/services/config_import_export_service.py`
  - [ ] 实现 `export_config(config_id: int) -> str`
    - [ ] 导出为 JSON 格式
    - [ ] 包含完整配置信息
    - [ ] 添加版本和元数据
  - [ ] 实现 `import_config(json_data: str, user_id: int) -> Dict`
    - [ ] 验证 JSON 格式
    - [ ] 验证配置合理性
    - [ ] 检查版本兼容性
    - [ ] 导入到数据库
  - [ ] 实现 `batch_export(config_ids: List[int]) -> str`
  - [ ] 实现 `batch_import(json_data: str, user_id: int) -> List`

### 6. 配置验证 (AC: 4)

- [ ] 创建 `server/src/services/config_validator.py`
  - [ ] 实现 `validate_weights(weights: Dict) -> ValidationResult`
    - [ ] 检查权重范围（0-1）
    - [ ] 检查权重总和（=1.0）
    - [ ] 检查必填字段
  - [ ] 实现 `validate_ma_periods(periods: List[int]) -> ValidationResult`
    - [ ] 检查周期有效性
    - [ ] 检查周期数量
  - [ ] 实现 `validate_completeness(config: Dict) -> ValidationResult`
    - [ ] 检查配置完整性
    - [ ] 检查字段类型
  - [ ] 返回详细的错误信息

### 7. 自定义配置计算 (AC: 5)

- [ ] 扩展 `server/src/services/calculation/ma_system/strength_calculator_v2.py`
  - [ ] 添加 `calculate_with_config(price, ma_values, config: WeightConfig)` 方法
    - [ ] 从配置读取权重
    - [ ] 使用自定义权重计算
  - [ ] 实现 `batch_calculate_with_config(entity_ids, date, config)` 方法
  - [ ] 添加缓存键区分（基于配置ID）

### 8. 配置推荐 (AC: 6)

- [ ] 创建 `server/src/services/config_recommender.py`
  - [ ] 实现 `backtest_config(config: WeightConfig, history_data: List) -> Dict`
    - [ ] 使用历史数据回测
    - [ ] 计算准确率、胜率等指标
    - [ ] 返回回测结果
  - [ ] 实现 `compare_configs(configs: List[WeightConfig]) -> Dict`
    - [ ] 对比多个配置
    - [ ] 生成对比报告
  - [ ] 实现 `recommend_config(user_preferences: Dict) -> List`
    - [ ] 基于用户偏好推荐
    - [ ] 返回推荐配置列表
  - [ ] 实现推荐算法
    - [ ] 基于历史表现
    - [ ] 基于风险偏好
    - [ ] 基于投资期限

### 9. API 端点 (AC: 1, 3)

- [ ] 创建 `server/src/api/v1/endpoints/weight_configs.py`
  - [ ] 实现 `POST /api/v1/weight-configs` 接口
    - [ ] 创建新配置
  - [ ] 实现 `GET /api/v1/weight-configs` 接口
    - [ ] 列出配置（支持分页）
    - [ ] 查询参数：user_only, include_public
  - [ ] 实现 `GET /api/v1/weight-configs/{config_id}` 接口
    - [ ] 获取配置详情
  - [ ] 实现 `PUT /api/v1/weight-configs/{config_id}` 接口
    - [ ] 更新配置
  - [ ] 实现 `DELETE /api/v1/weight-configs/{config_id}` 接口
    - [ ] 删除配置
  - [ ] 实现 `POST /api/v1/weight-configs/{config_id}/activate` 接口
    - [ ] 设置为激活配置
  - [ ] 实现 `GET /api/v1/weight-configs/{config_id}/export` 接口
    - [ ] 导出配置
  - [ ] 实现 `POST /api/v1/weight-configs/import` 接口
    - [ ] 导入配置
  - [ ] 实现 `GET /api/v1/weight-configs/presets` 接口
    - [ ] 获取预设配置列表
  - [ ] 实现 `POST /api/v1/weight-configs/{config_id}/backtest` 接口
    - [ ] 执行回测
  - [ ] 实现 `GET /api/v1/weight-configs/recommend` 接口
    - [ ] 获取推荐配置

### 10. 测试 (AC: 8)

- [ ] 创建 `server/tests/services/test_weight_config_service.py`
  - [ ] 测试配置 CRUD
  - [ ] 测试权限验证
  - [ ] 测试配置验证
- [ ] 创建 `server/tests/services/test_config_validator.py`
  - [ ] 测试权重验证
  - [ ] 测试边界条件
- [ ] 创建 `server/tests/services/test_config_recommender.py`
  - [ ] 测试回测功能
  - [ ] 测试推荐算法
- [ ] 创建 `server/tests/api/test_weight_config_endpoints.py`
  - [ ] 测试所有 API 端点
  - [ ] 测试导入导出
- [ ] 集成测试

## Dev Notes

### 故事依赖关系

**前置依赖**:
- Story 10.1: 数据库表结构优化
- Story 10.2: 均线系统强度计算引擎
- Story 10.3: 强度数据服务
- Story 10.4: 强度 API 接口

**被以下故事依赖**:
- 前端自定义配置界面开发

### 权重配置数据结构

```python
# 权重配置 JSON 结构
{
    "version": "1.0",
    "name": "平衡型配置",
    "description": "价格位置和均线排列平衡配置",

    # 主维度权重
    "dimension_weights": {
        "price_position": 0.5,    # 价格位置权重
        "ma_alignment": 0.5        # 均线排列权重
    },

    # 均线周期权重（价格位置计算用）
    "ma_period_weights": {
        "5": 0.15,
        "10": 0.15,
        "20": 0.18,
        "30": 0.15,
        "60": 0.15,
        "90": 0.10,
        "120": 0.07,
        "240": 0.05
    },

    # 短中长期分组权重
    "term_weights": {
        "short": {     # 短期：MA5/10/20
            "5": 0.35,
            "10": 0.35,
            "20": 0.30
        },
        "medium": {    # 中期：MA30/60
            "30": 0.50,
            "60": 0.50
        },
        "long": {      # 长期：MA90/120/240
            "90": 0.40,
            "120": 0.30,
            "240": 0.30
        }
    },

    # 价格位置评分曲线参数
    "price_score_params": {
        "very_high_threshold": 5.0,     # 远高于均线阈值（%）
        "high_threshold": 3.0,
        "medium_high_threshold": 1.0,
        "medium_threshold": 0.5,
        "medium_low_threshold": -0.5,
        "low_threshold": -1.0,
        "very_low_threshold": -3.0,
        "extreme_low_threshold": -5.0
    },

    # 均线排列评分参数
    "alignment_score_params": {
        "perfect_ratio": 1.0,           # 100% 符合
        "strong_ratio": 0.75,           # 75% 符合
        "moderate_ratio": 0.5,          # 50% 符合
        "weak_ratio": 0.25              # 25% 符合
    },

    # 元数据
    "metadata": {
        "created_by": "system",
        "created_at": "2024-12-28T00:00:00Z",
        "tags": ["balanced", "default"],
        "risk_level": "medium"
    }
}
```

### 预设配置定义

```python
# server/src/config/weight_presets.py

CONSERVATIVE_PRESET = {
    "version": "1.0",
    "name": "保守型",
    "description": "注重长期趋势，适合稳健投资者",
    "dimension_weights": {
        "price_position": 0.4,
        "ma_alignment": 0.6
    },
    "ma_period_weights": {
        "5": 0.10,   # 降低短期权重
        "10": 0.10,
        "20": 0.15,
        "30": 0.15,
        "60": 0.18,  # 提高中期权重
        "90": 0.12,
        "120": 0.10,
        "240": 0.10  # 提高长期权重
    },
    "metadata": {
        "risk_level": "low",
        "tags": ["conservative", "long-term"]
    }
}

BALANCED_PRESET = {
    "version": "1.0",
    "name": "平衡型",
    "description": "价格位置与均线排列平衡，系统默认配置",
    "dimension_weights": {
        "price_position": 0.5,
        "ma_alignment": 0.5
    },
    "ma_period_weights": {
        "5": 0.15,
        "10": 0.15,
        "20": 0.18,
        "30": 0.15,
        "60": 0.15,
        "90": 0.10,
        "120": 0.07,
        "240": 0.05
    },
    "metadata": {
        "risk_level": "medium",
        "tags": ["balanced", "default"]
    }
}

AGGRESSIVE_PRESET = {
    "version": "1.0",
    "name": "激进型",
    "description": "注重短期表现，适合积极投资者",
    "dimension_weights": {
        "price_position": 0.6,   # 提高价格位置权重
        "ma_alignment": 0.4
    },
    "ma_period_weights": {
        "5": 0.20,   # 大幅提高短期权重
        "10": 0.20,
        "20": 0.20,
        "30": 0.15,
        "60": 0.12,
        "90": 0.08,
        "120": 0.03,
        "240": 0.02  # 降低长期权重
    },
    "metadata": {
        "risk_level": "high",
        "tags": ["aggressive", "short-term"]
    }
}

MOMENTUM_PRESET = {
    "version": "1.0",
    "name": "动量型",
    "description": "捕捉短期动量机会",
    "dimension_weights": {
        "price_position": 0.7,   # 极度重视价格位置
        "ma_alignment": 0.3
    },
    "ma_period_weights": {
        "5": 0.40,   # 极端重视 MA5
        "10": 0.30,
        "20": 0.20,
        "30": 0.05,
        "60": 0.03,
        "90": 0.01,
        "120": 0.01,
        "240": 0.00
    },
    "price_score_params": {
        "very_high_threshold": 3.0,   # 降低阈值，更敏感
        "high_threshold": 2.0,
        "medium_high_threshold": 1.0,
        "medium_threshold": 0.5,
        "medium_low_threshold": -0.5,
        "low_threshold": -1.0,
        "very_low_threshold": -2.0,
        "extreme_low_threshold": -3.0
    },
    "metadata": {
        "risk_level": "very_high",
        "tags": ["momentum", "short-term"]
    }
}

ALL_PRESETS = {
    "conservative": CONSERVATIVE_PRESET,
    "balanced": BALANCED_PRESET,
    "aggressive": AGGRESSIVE_PRESET,
    "momentum": MOMENTUM_PRESET
}
```

### 配置验证实现

```python
# server/src/services/config_validator.py

from typing import Dict, List
from pydantic import BaseModel, ValidationError


class ValidationResult(BaseModel):
    """验证结果"""
    is_valid: bool
    errors: List[str] = []
    warnings: List[str] = []


class ConfigValidator:
    """配置验证器"""

    @staticmethod
    def validate_weights(weights: Dict) -> ValidationResult:
        """验证权重配置"""
        errors = []
        warnings = []

        # 检查必填字段
        required_fields = ["dimension_weights", "ma_period_weights"]
        for field in required_fields:
            if field not in weights:
                errors.append(f"缺少必填字段: {field}")

        # 验证主维度权重
        if "dimension_weights" in weights:
            dim_weights = weights["dimension_weights"]
            total = sum(dim_weights.values())

            if abs(total - 1.0) > 0.01:
                errors.append(f"主维度权重总和应为1.0，当前为{total:.2f}")

            for key, value in dim_weights.items():
                if not (0 <= value <= 1):
                    errors.append(f"主维度权重 {key} 应在0-1之间，当前为{value}")

        # 验证均线周期权重
        if "ma_period_weights" in weights:
            ma_weights = weights["ma_period_weights"]
            total = sum(ma_weights.values())

            if abs(total - 1.0) > 0.01:
                errors.append(f"均线周期权重总和应为1.0，当前为{total:.2f}")

            required_periods = [5, 10, 20, 30, 60, 90, 120, 240]
            for period in required_periods:
                if str(period) not in ma_weights:
                    errors.append(f"缺少均线周期: MA{period}")

            for key, value in ma_weights.items():
                if not (0 <= value <= 1):
                    errors.append(f"均线权重 {key} 应在0-1之间，当前为{value}")

        return ValidationResult(
            is_valid=len(errors) == 0,
            errors=errors,
            warnings=warnings
        )

    @staticmethod
    def validate_completeness(config: Dict) -> ValidationResult:
        """验证配置完整性"""
        errors = []
        required_keys = [
            "version",
            "name",
            "dimension_weights",
            "ma_period_weights"
        ]

        for key in required_keys:
            if key not in config:
                errors.append(f"缺少必填字段: {key}")

        # 验证版本号
        if "version" in config:
            try:
                version_parts = config["version"].split(".")
                if len(version_parts) != 2:
                    errors.append("版本号格式不正确，应为 'x.y'")
            except:
                errors.append("版本号格式不正确")

        return ValidationResult(
            is_valid=len(errors) == 0,
            errors=errors
        )

    @staticmethod
    def validate_all(config: Dict) -> ValidationResult:
        """执行所有验证"""
        result1 = ConfigValidator.validate_completeness(config)
        result2 = ConfigValidator.validate_weights(config)

        return ValidationResult(
            is_valid=result1.is_valid and result2.is_valid,
            errors=result1.errors + result2.errors,
            warnings=result1.warnings + result2.warnings
        )
```

### 自定义配置计算实现

```python
# 扩展强度计算器

class StrengthCalculatorV2:
    """强度计算器 V2（支持自定义配置）"""

    @staticmethod
    def calculate_with_config(
        price: float,
        ma_values: Dict[int, float],
        config: Dict
    ) -> Dict:
        """
        使用自定义配置计算强度

        Args:
            price: 当前价格
            ma_values: 均线值字典 {period: value}
            config: 权重配置

        Returns:
            强度计算结果
        """
        # 1. 价格位置得分（使用配置的权重）
        price_score = StrengthCalculatorV2._calculate_price_position_with_config(
            price, ma_values, config
        )

        # 2. 均线排列得分
        alignment_score, alignment_state = StrengthCalculatorV2._calculate_ma_alignment(
            price, ma_values
        )

        # 3. 综合得分（使用配置的主维度权重）
        dimension_weights = config.get("dimension_weights", {
            "price_position": 0.5,
            "ma_alignment": 0.5
        })

        composite = (
            price_score * dimension_weights["price_position"] +
            alignment_score * dimension_weights["ma_alignment"]
        )

        # 4. 短中长期强度
        term_scores = StrengthCalculatorV2._calculate_term_scores_with_config(
            price, ma_values, config
        )

        return {
            'composite_score': round(composite, 2),
            'price_position_score': round(price_score, 2),
            'ma_alignment_score': round(alignment_score, 2),
            'ma_alignment_state': alignment_state,
            'short_term_score': round(term_scores['short'], 2),
            'medium_term_score': round(term_scores['medium'], 2),
            'long_term_score': round(term_scores['long'], 2),
            'config_used': config.get("name", "custom")
        }

    @staticmethod
    def _calculate_price_position_with_config(
        price: float,
        ma_values: Dict[int, float],
        config: Dict
    ) -> float:
        """使用自定义权重计算价格位置得分"""
        # 获取配置的均线权重
        ma_weights = config.get("ma_period_weights", {
            "5": 0.15, "10": 0.15, "20": 0.18, "30": 0.15,
            "60": 0.15, "90": 0.10, "120": 0.07, "240": 0.05
        })

        total_score = 0
        total_weight = 0

        for period_str, weight in ma_weights.items():
            period = int(period_str)
            if period in ma_values:
                ma_value = ma_values[period]
                ratio = (price - ma_value) / ma_value * 100

                # 使用配置的评分参数（如果有）
                score_params = config.get("price_score_params", {})
                score = StrengthCalculatorV2._price_position_score_with_params(
                    ratio, score_params
                )

                total_score += score * weight
                total_weight += weight

        return total_score / total_weight if total_weight > 0 else 50
```

### 配置推荐算法

```python
# server/src/services/config_recommender.py

import numpy as np
from typing import List, Dict
from server.src.models.weight_config import WeightConfig
from server.src.models.strength_score import StrengthScore


class ConfigRecommender:
    """配置推荐器"""

    @staticmethod
    def backtest_config(
        config: WeightConfig,
        history_data: List[StrengthScore],
        lookback_days: int = 30
    ) -> Dict:
        """
        回测配置性能

        Args:
            config: 权重配置
            history_data: 历史强度数据
            lookback_days: 回测天数

        Returns:
            回测结果
        """
        if len(history_data) < lookback_days * 2:
            return {"error": "历史数据不足"}

        results = []
        config_data = config.config_data

        for i in range(len(history_data) - lookback_days, len(history_data)):
            current = history_data[i]
            prev = history_data[i - lookback_days]

            # 使用配置重新计算强度
            # （这里需要从均线数据重新计算）
            # 简化版本：直接使用现有数据

            change = float(current.score) - float(prev.score)

            results.append({
                "date": current.date,
                "score_change": change,
                "final_score": float(current.score)
            })

        # 计算统计指标
        score_changes = [r["score_change"] for r in results]

        avg_change = np.mean(score_changes)
        positive_days = sum(1 for c in score_changes if c > 0)
        win_rate = positive_days / len(score_changes) if score_changes else 0

        return {
            "config_id": config.id,
            "config_name": config.name,
            "lookback_days": lookback_days,
            "test_days": len(results),
            "avg_score_change": round(avg_change, 2),
            "win_rate": round(win_rate * 100, 2),
            "max_gain": round(max(score_changes), 2) if score_changes else 0,
            "max_loss": round(min(score_changes), 2) if score_changes else 0,
            "std_dev": round(np.std(score_changes), 2) if score_changes else 0,
            "sharpe_ratio": round(avg_change / np.std(score_changes), 2)
                           if np.std(score_changes) > 0 else 0
        }

    @staticmethod
    def recommend_by_user_preferences(preferences: Dict) -> List[Dict]:
        """
        根据用户偏好推荐配置

        Args:
            preferences: 用户偏好
                - risk_tolerance: "low", "medium", "high"
                - investment_horizon: "short", "medium", "long"
                - focus: "trend", "momentum", "balanced"

        Returns:
            推荐配置列表
        """
        risk = preferences.get("risk_tolerance", "medium")
        horizon = preferences.get("investment_horizon", "medium")
        focus = preferences.get("focus", "balanced")

        recommendations = []

        # 根据偏好匹配预设配置
        if risk == "low" and horizon == "long":
            recommendations.append({
                "config_name": "保守型",
                "preset_key": "conservative",
                "match_score": 95,
                "reason": "适合低风险、长期投资偏好"
            })

        if risk == "high" and horizon == "short" and focus == "momentum":
            recommendations.append({
                "config_name": "动量型",
                "preset_key": "momentum",
                "match_score": 90,
                "reason": "适合高风险、短期动量捕捉"
            })

        if risk == "high" and horizon == "short":
            recommendations.append({
                "config_name": "激进型",
                "preset_key": "aggressive",
                "match_score": 85,
                "reason": "适合高风险、短期投资偏好"
            })

        # 默认推荐平衡型
        if not recommendations:
            recommendations.append({
                "config_name": "平衡型",
                "preset_key": "balanced",
                "match_score": 70,
                "reason": "适合大多数投资者"
            })

        return recommendations
```

### API 响应示例

```python
# GET /api/v1/weight-configs
{
    "total": 5,
    "items": [
        {
            "id": 1,
            "name": "平衡型",
            "description": "价格位置与均线排列平衡配置",
            "user_id": null,
            "is_active": true,
            "is_public": true,
            "created_at": "2024-12-28T00:00:00Z",
            "metadata": {
                "risk_level": "medium",
                "tags": ["balanced", "default"]
            }
        }
    ]
}

# POST /api/v1/weight-configs
# Request:
{
    "name": "我的自定义配置",
    "description": "偏重长期趋势",
    "dimension_weights": {
        "price_position": 0.4,
        "ma_alignment": 0.6
    },
    "ma_period_weights": {
        "5": 0.10,
        "10": 0.12,
        "20": 0.15,
        "30": 0.15,
        "60": 0.18,
        "90": 0.12,
        "120": 0.10,
        "240": 0.08
    }
}

# Response:
{
    "id": 123,
    "name": "我的自定义配置",
    "description": "偏重长期趋势",
    "user_id": 456,
    "is_active": true,
    "config_data": { ... },
    "created_at": "2024-12-28T10:30:00Z"
}
```

### 源树组件需要修改

```
server/
├── src/
│   └── models/
│       └── weight_config.py                     # 新建：权重配置模型
├── src/
│   └── api/
│       └── schemas/
│           └── weight_config.py                 # 新建：Schema 定义
├── src/
│   └── services/
│       ├── weight_config_service.py             # 新建：配置服务
│       ├── config_validator.py                  # 新建：配置验证
│       ├── config_import_export_service.py      # 新建：导入导出
│       └── config_recommender.py                # 新建：配置推荐
├── src/
│   └── config/
│       └── weight_presets.py                    # 新建：预设配置
├── src/
│   └── api/
│       └── v1/
│           └── endpoints/
│               └── weight_configs.py            # 新建：API 端点
├── alembic/
│   └── versions/
│       └── YYYYMMDDHHMMSS_add_weight_configs_table.py  # 新建迁移
└── tests/
    ├── services/
    │   ├── test_weight_config_service.py        # 新建
    │   ├── test_config_validator.py             # 新建
    │   └── test_config_recommender.py           # 新建
    └── api/
        └── test_weight_config_endpoints.py      # 新建
```

### 数据库表设计

```sql
CREATE TABLE weight_configs (
    id INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY,

    -- 基本信息
    name VARCHAR(100) NOT NULL,
    description TEXT,

    -- 用户信息
    user_id INTEGER,                              -- NULL 表示系统预设
    is_active BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT FALSE,

    -- 配置数据（JSON）
    config_data JSONB NOT NULL,

    -- 回测结果（可选）
    backtest_results JSONB,

    -- 元数据
    metadata JSONB,

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外键
    CONSTRAINT fk_weight_configs_user
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    -- 约束
    CONSTRAINT chk_weight_configs_name_not_empty
        CHECK (LENGTH(TRIM(name)) > 0)
);

-- 索引
CREATE INDEX idx_weight_configs_user_id ON weight_configs(user_id);
CREATE INDEX idx_weight_configs_is_active ON weight_configs(is_active);
CREATE INDEX idx_weight_configs_is_public ON weight_configs(is_public);
```

### 测试标准摘要

**单元测试要求**:
1. 配置验证准确性测试
2. 权重计算正确性测试
3. 边界条件测试
4. 权限验证测试

**集成测试要求**:
1. 完整配置 CRUD 流程测试
2. 导入导出功能测试
3. 回测功能测试
4. API 端点测试

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

glm-4.7

### Completion Notes

待完成...
