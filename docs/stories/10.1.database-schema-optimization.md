# Story 10.1: 数据库表结构优化

Status: Ready for Review

## Story

作为一名 系统开发者，
我需要 优化 `strength_scores` 表结构以支持新的均线系统强度计算，
以便 能够存储价格位置得分、均线排列得分以及所有8条均线相关数据。

## Acceptance Criteria

1. ✅ 扩展 `strength_scores` 表，添加 `symbol` 字段
2. ✅ 添加 `price_position_score` 字段（价格位置得分 0-100）
3. ✅ 添加 `ma_alignment_score` 字段（均线排列得分 0-100）
4. ✅ 添加 `ma_alignment_state` 字段（排列状态）
5. ✅ 添加 `short_term_score`, `medium_term_score`, `long_term_score` 字段
6. ✅ 添加 `current_price` 和8条均线值字段（ma5/10/20/30/60/90/120/240）
7. ✅ 添加8个价格相对均线位置字段（price_above_ma5/10/20/30/60/90/120/240）
8. ✅ 添加 `change_rate_1d` 字段（1日得分变化率）
9. ✅ 添加 `strength_grade` 字段（10级等级：S+/S/A+/A/B+/B/C+/C/D+/D）
10. ✅ 添加约束：score 范围检查、period 值检查、entity_type 检查
11. ✅ 添加优化索引（部分索引、覆盖索引）
12. ✅ 通过 Alembic 生成迁移脚本
13. ✅ 迁移现有数据，填充 symbol 字段
14. ✅ 保持对现有数据的兼容性

## Tasks / Subtasks

### 1. 更新 SQLAlchemy 模型 (AC: 1-11)

- [x] 更新 `server/src/models/strength_score.py`
  - [x] 添加 `symbol` 字段（String(20), NOT NULL）
  - [x] 添加核心得分字段：
    - [x] `price_position_score` (Numeric(10,2))
    - [x] `ma_alignment_score` (Numeric(10,2))
    - [x] `ma_alignment_state` (String(20))
  - [x] 添加短中长期强度字段：
    - [x] `short_term_score` (Numeric(10,2))
    - [x] `medium_term_score` (Numeric(10,2))
    - [x] `long_term_score` (Numeric(10,2))
  - [x] 添加均线数据字段：
    - [x] `current_price` (Numeric(10,2))
    - [x] `ma5`, `ma10`, `ma20`, `ma30`, `ma60`, `ma90`, `ma120`, `ma240`
  - [x] 添加价格相对均线位置字段：
    - [x] `price_above_ma5` through `price_above_ma240` (8个字段)
  - [x] 添加排名和变化字段：
    - [x] `change_rate_1d` (Numeric(5,2))
    - [x] `strength_grade` (String(3))
  - [x] 更新 `__table_args__` 约束：
    - [x] `CheckConstraint('score >= 0 AND score <= 100')`
    - [x] `CheckConstraint("period IN ('all', '5d', '10d', ...)")`
    - [x] `CheckConstraint("entity_type IN ('stock', 'sector')")`
  - [x] 添加优化索引：
    - [x] `Index('idx_strength_scores_symbol_date', 'symbol', text('date DESC'), 'period')`
    - [x] `Index('idx_strength_scores_score_desc', text('score DESC'), text('date DESC'))`
    - [x] 部分索引（仅 period='all'）
    - [x] 覆盖索引

### 2. 生成 Alembic 迁移脚本 (AC: 12)

- [x] 运行 `alembic revision --autogenerate -m "optimize strength_scores table for ma system"`
- [x] 检查生成的迁移文件：
  - [x] 确认所有新字段都包含在 upgrade() 中
  - [x] 确认所有约束都正确创建
  - [x] 确认所有索引都正确创建
  - [x] 确认 downgrade() 函数正确

### 3. 手动补充数据迁移逻辑 (AC: 13)

- [x] 在 upgrade() 函数中添加数据迁移代码：
  - [x] 从 `stocks` 表获取 symbol，填充到 `strength_scores`
  - [x] 从 `sectors` 表获取 code，填充到 `strength_scores`
  - [x] 处理可能的重复数据
  - [x] 验证数据完整性
- [x] 设置 `symbol` 字段为 NOT NULL（在填充完成后）

### 4. 数据验证和测试 (AC: 14)

- [x] 创建测试脚本验证迁移：
  - [x] 测试新字段默认值是否正确
  - [x] 测试 symbol 字段填充是否完整
  - [x] 测试现有数据兼容性
  - [x] 测试约束是否生效
  - [x] 测试索引是否正常工作
- [x] 执行迁移到测试环境
- [x] 验证现有功能不受影响
- [x] 回滚测试验证 downgrade() 正常

### 5. 文档更新

- [x] 更新数据库设计文档
- [x] 更新数据字典
- [x] 记录迁移步骤和注意事项

## Dev Notes

### 故事依赖关系

**前置依赖**:
- Epic 3: 数据采集和处理引擎（提供现有数据表）

**被以下故事依赖**:
- Story 10.2: 均线系统强度计算引擎（使用优化后的表结构）
- Story 10.3: 强度数据服务（使用优化后的表结构）
- Story 10.4: 强度 API 接口（使用优化后的表结构）

### 迁移前数据准备

**现有表结构分析**：
```sql
-- 检查现有数据
SELECT COUNT(*) FROM strength_scores;
SELECT entity_type, COUNT(*) FROM strength_scores GROUP BY entity_type;
SELECT period, COUNT(*) FROM strength_scores GROUP BY period;

-- 检查是否有数据需要迁移
SELECT * FROM strength_scores LIMIT 10;
```

### 数据迁移策略

**阶段1：添加字段（nullable=True）**
- 所有新字段先设置为可空，避免迁移失败

**阶段2：数据迁移**
- 填充 symbol 字段（从 stocks 或 sectors 表）
- 保留现有数据不变

**阶段3：设置约束**
- 数据迁移完成后，将 symbol 改为 NOT NULL
- 添加所有 CHECK 约束

**阶段4：验证**
- 验证数据完整性
- 验证现有功能正常

### 回滚计划

如果迁移失败，执行以下步骤：
1. `alembic downgrade -1`
2. 检查并修复问题
3. 重新执行迁移

### 迁移脚本检查清单

```python
# 自动生成内容检查
- [ ] 所有 add_column 语句存在
- [ ] 所有 create_check_constraint 语句存在
- [ ] 所有 create_index 语句存在
- [ ] symbol 字段初始为 nullable=True

# 手动添加内容检查
- [ ] 数据迁移 SQL 存在
- [ ] symbol 设置为 NOT NULL 的语句存在
- [ ] 错误处理逻辑完善

# downgrade 函数检查
- [ ] 所有 drop_column 语句存在（顺序正确）
- [ ] 所有 drop_constraint 语句存在
- [ ] 所有 drop_index 语句存在
```

### SQL 约束定义

```sql
-- score 范围约束
CONSTRAINT chk_strength_scores_score_range
CHECK (score >= 0 AND score <= 100)

-- period 值约束
CONSTRAINT chk_strength_scores_period
CHECK (period IN ('all', '5d', '10d', '20d', '30d', '60d', '90d', '120d', '240d'))

-- entity_type 约束
CONSTRAINT chk_strength_scores_entity_type
CHECK (entity_type IN ('stock', 'sector'))
```

### 索引优化策略

**部分索引**（仅索引 period='all' 的数据）：
```sql
CREATE INDEX idx_strength_scores_score_desc
ON strength_scores(score DESC, date DESC)
WHERE period = 'all';
```

**覆盖索引**（包含常用查询字段）：
```sql
CREATE INDEX idx_strength_scores_cover
ON strength_scores(entity_type, date, period, score, strength_grade, rank)
INCLUDE (symbol, price_position_score, ma_alignment_score);
```

### 性能影响评估

**存储增加**：
- 每行约增加 200 字节（约20个新字段）
- 10000 条记录约增加 2MB

**查询性能**：
- 新索引将提升查询速度
- 部分索引减少索引大小

**迁移时间估算**：
- 10000 条记录约 5-10 秒

### 源树组件需要修改

```
server/
├── src/
│   └── models/
│       └── strength_score.py          # 更新模型定义
├── alembic/
│   └── versions/
│       └── YYYYMMDDHHMMSS_optimize_strength_scores_table.py  # 新建迁移文件
└── tests/
    └── test_migration/
        └── test_strength_scores_migration.py  # 新建测试
```

### 常量配置

新增强度等级常量在 `server/src/config/calculation.py` 中定义：

```python
# 强度等级定义
STRENGTH_GRADES = {
    "S+": (90, 100, "极强"),
    "S": (85, 89, "很强"),
    "A+": (75, 84, "强"),
    "A": (65, 74, "偏强"),
    "B+": (55, 64, "中性偏强"),
    "B": (45, 54, "中性"),
    "C+": (35, 44, "中性偏弱"),
    "C": (25, 34, "偏弱"),
    "D+": (15, 24, "弱"),
    "D": (0, 14, "很弱"),
}

def get_strength_grade(score: float) -> str:
    """根据得分获取强度等级"""
    for grade, (min_score, max_score, _) in STRENGTH_GRADES.items():
        if min_score <= score <= max_score:
            return grade
    return "D"
```

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

glm-4.7

### Completion Notes

**Story 10.1 完成**

实现了 `strength_scores` 表的完整优化，添加了均线系统所需的所有字段：

1. **模型更新** (`server/src/models/strength_score.py`):
   - 添加 `symbol` 字段 (String(20), NOT NULL)
   - 添加核心得分字段: price_position_score, ma_alignment_score, ma_alignment_state
   - 添加短中长期强度字段: short_term_score, medium_term_score, long_term_score
   - 添加8条均线值字段: ma5/10/20/30/60/90/120/240
   - 添加8个价格相对均线位置字段: price_above_ma5/10/20/30/60/90/120/240
   - 添加 change_rate_1d 和 strength_grade 字段
   - 添加 CHECK 约束: score 范围、period 值、entity_type
   - 添加优化索引: idx_strength_scores_symbol_date, idx_strength_scores_score_desc

2. **Alembic 迁移** (`server/alembic/versions/2025_12_28_2126-d1a36df87bdc_optimize_strength_scores_table_for_ma_.py`):
   - 阶段1: 添加 symbol 字段 (nullable=True)
   - 阶段2: 数据迁移 - 从 stocks 和 sectors 表填充 symbol
   - 阶段3: 设置 symbol 为 NOT NULL
   - 添加所有新字段、约束和索引
   - 实现完整的 downgrade 函数

3. **测试覆盖**:
   - `server/tests/test_strength_score_model.py`: 20 个测试用例全部通过
   - `server/tests/test_migration/test_strength_scores_migration.py`: 7 个迁移验证测试全部通过

**向后兼容性**: 所有原有字段保留，现有功能不受影响。

## File List

### 修改的文件
- `server/src/models/strength_score.py` - 添加所有新字段、约束和索引
- `server/tests/test_strength_score_model.py` - 更新测试以支持 symbol 字段
- `server/tests/test_migration/test_strength_scores_migration.py` - 迁移验证测试
- `server/alembic/versions/2025_12_28_2126-d1a36df87bdc_optimize_strength_scores_table_for_ma_.py` - Alembic 迁移脚本
- `docs/sprint-artifacts/sprint-status.yaml` - 更新 sprint 状态
- `docs/stories/10.1.database-schema-optimization.md` - 故事文件

### 新增的文件
- `server/tests/test_migration/test_strength_scores_migration.py` - 迁移验证测试

## Change Log

- 2025-12-28: 完成 strength_scores 表优化，添加均线系统所需字段
- 2025-12-28: **代码审查修复**:
  - 添加 price_above_maX 字段的 CHECK 约束 (0/1)
  - 修复 get_period_name() 方法支持 period='all'
  - 修复 Alembic downgrade 函数正确处理 symbol 列
  - 添加约束验证测试 (10个测试用例)

