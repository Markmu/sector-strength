# Story 9.4: 异步任务系统

## Status
Ready for Review

## Story
**As a** 系统开发者
**I want** 实现基于数据库的轻量级异步任务系统
**so that** 数据初始化和更新操作不会阻塞用户界面，用户可以看到实时进度

## Acceptance Criteria
1. ✅ 实现基于数据库的任务队列（无需 Redis）
2. ✅ 后台线程在 FastAPI 进程内运行，轮询任务表
3. ✅ 支持任务状态：pending, running, completed, failed, cancelled
4. ✅ 支持任务进度跟踪（当前步骤、总数、百分比）
5. ✅ 支持任务取消（正在运行的任务可被取消）
6. ✅ 支持任务失败后自动重试（最多 3 次，指数退避）
7. ✅ 任务执行超时控制（默认 4 小时）
8. ✅ 任务错误信息记录到数据库
9. ✅ 支持并发控制（最多同时运行 2 个任务）

## Tasks / Subtasks
### 数据库设计
- [x] 创建任务表（async_tasks）
  - [x] id, task_type, status, progress, total, error_message
  - [x] retry_count, max_retries, timeout_seconds
  - [x] created_at, started_at, completed_at, cancelled_at
- [x] 创建任务参数表（async_task_params）
  - [x] task_id, key, value
- [x] 创建任务日志表（async_task_logs）
  - [x] task_id, level, message, created_at

### 后端实现 - 任务核心
- [x] 创建任务模型
  - [x] `AsyncTask` 模型
  - [x] `AsyncTaskParam` 模型
  - [x] `AsyncTaskLog` 模型
- [x] 创建任务管理器
  - [x] `TaskManager` 类
  - [x] `create_task(task_type, params)` - 创建任务
  - [x] `get_task(task_id)` - 获取任务状态
  - [x] `cancel_task(task_id)` - 取消任务
  - [x] `update_progress(task_id, current, total)` - 更新进度
  - [x] `log_message(task_id, level, message)` - 记录日志
- [x] 创建任务执行器
  - [x] `TaskExecutor` 类
  - [x] 轮询任务表（间隔 1 秒）
  - [x] 执行 pending 任务
  - [x] 处理超时和重试
  - [x] 并发控制

### 后端实现 - 任务注册
- [x] 创建任务注册表
  - [x] `@task` 装饰器注册任务函数
  - [x] 任务类型映射到处理函数
- [x] 实现任务处理器
  - [x] `init_sectors_task()` - 板块初始化任务
  - [x] `init_stocks_task()` - 股票初始化任务
  - [x] `backfill_by_date_task()` - 日期补齐任务
  - [x] `backfill_by_range_task()` - 时间段补齐任务

### FastAPI 集成
- [x] 启动时创建后台线程
  - [x] 在 `main.py` 中启动 TaskExecutor
- [x] 优雅关闭处理
  - [x] 应用关闭时等待任务完成或超时

### API 端点
- [x] GET /api/admin/tasks - 获取任务列表
- [x] GET /api/admin/tasks/{task_id} - 获取任务详情
- [x] POST /api/admin/tasks/{task_id}/cancel - 取消任务
- [x] GET /api/admin/tasks/{task_id}/logs - 获取任务日志

### 前端集成
- [x] 创建任务 API 客户端
- [x] 创建任务状态 Hook
  - [x] `useTaskStatus(task_id)` - 轮询任务状态
- [ ] 任务进度组件（在 Story 9.5 实现）

### 测试
- [x] 单元测试：任务管理器
- [x] 单元测试：任务执行器
- [x] 集成测试：完整任务生命周期
- [x] 测试：任务取消
- [x] 测试：重试机制
- [x] 测试：并发控制

## Technical Requirements
- 数据库：PostgreSQL 存储任务状态
- 轮询间隔：1 秒
- 并发限制：最多 2 个任务同时运行
- 重试策略：指数退避（1s, 2s, 4s），最多 3 次
- 超时：默认 4 小时

## Database Schema
```sql
-- 异步任务表
CREATE TABLE async_tasks (
    id SERIAL PRIMARY KEY,
    task_id VARCHAR(50) UNIQUE NOT NULL,
    task_type VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',  -- pending, running, completed, failed, cancelled
    progress INTEGER DEFAULT 0,
    total INTEGER DEFAULT 0,
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    max_retries INTEGER DEFAULT 3,
    timeout_seconds INTEGER DEFAULT 14400,  -- 4 hours
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    cancelled_at TIMESTAMP
);

-- 任务参数表
CREATE TABLE async_task_params (
    id SERIAL PRIMARY KEY,
    task_id VARCHAR(50) REFERENCES async_tasks(task_id) ON DELETE CASCADE,
    key VARCHAR(100) NOT NULL,
    value TEXT,
    UNIQUE(task_id, key)
);

-- 任务日志表
CREATE TABLE async_task_logs (
    id SERIAL PRIMARY KEY,
    task_id VARCHAR(50) REFERENCES async_tasks(task_id) ON DELETE CASCADE,
    level VARCHAR(20) NOT NULL,  -- INFO, WARNING, ERROR
    message TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_async_tasks_status ON async_tasks(status);
CREATE INDEX idx_async_tasks_created_at ON async_tasks(created_at DESC);
CREATE INDEX idx_async_task_logs_task_id ON async_task_logs(task_id, created_at);
```

## Architecture Design
```
┌─────────────────────────────────────────────────────────────┐
│                     FastAPI Application                       │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┐         ┌─────────────────────────────┐   │
│  │   API       │         │   Background Thread          │   │
│  │   Requests  │────────▶│   (TaskExecutor)             │   │
│  └─────────────┘         │  - Poll every 1s             │   │
│                          │  - Execute pending tasks     │   │
│                          │  - Update progress           │   │
│                          └──────────┬──────────────────┘   │
│                                     │                        │
│                                     ▼                        │
│                          ┌─────────────────────┐           │
│                          │   PostgreSQL        │           │
│                          │   - async_tasks     │           │
│                          │   - async_task_logs │           │
│                          └─────────────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

## Task Flow
```
1. 创建任务
   API → TaskManager.create_task() → 插入任务记录 (status=pending)

2. 任务执行
   TaskExecutor (polling) → 发现 pending 任务
   → 更新状态为 running
   → 调用任务处理函数
   → 更新进度

3. 任务完成
   → 更新状态为 completed/failed
   → 记录完成时间

4. 任务重试
   → 失败时 retry_count++
   → 如果 retry_count < max_retries
   → 重新放入 pending (延迟重试)

5. 任务取消
   API → TaskManager.cancel_task()
   → 更新状态为 cancelled
   → 任务执行器检查状态后停止
```

## API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/admin/tasks | 获取任务列表（分页） |
| GET | /api/admin/tasks/{task_id} | 获取任务详情 |
| POST | /api/admin/tasks/{task_id}/cancel | 取消任务 |
| GET | /api/admin/tasks/{task_id}/logs | 获取任务日志（分页） |

## Response Examples
### 任务列表
```json
{
  "tasks": [
    {
      "taskId": "task_abc123",
      "taskType": "init_stocks",
      "status": "running",
      "progress": 1500,
      "total": 5000,
      "percent": 30,
      "createdAt": "2025-12-24T10:00:00Z",
      "startedAt": "2025-12-24T10:00:05Z"
    }
  ],
  "total": 25,
  "page": 1
}
```

### 任务详情
```json
{
  "taskId": "task_abc123",
  "taskType": "init_stocks",
  "status": "running",
  "progress": 1500,
  "total": 5000,
  "percent": 30,
  "params": {
    "days": 60,
    "overwrite": false
  },
  "error": null,
  "retryCount": 0,
  "createdAt": "2025-12-24T10:00:00Z",
  "startedAt": "2025-12-24T10:00:05Z"
}
```

## Dependencies
- Epic 1（数据库和 API 框架）
- Story 9.1（管理员权限）

## Definition of Done
- [x] 所有验收标准完成
- [x] 任务表创建成功
- [x] 任务执行器正常运行
- [x] 任务取消功能测试通过
- [x] 重试机制测试通过
- [x] 并发控制测试通过
- [x] API 文档更新

## Risk Assessment
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 后台线程崩溃 | 任务停止 | 健康检查 + 自动重启 |
| 数据库连接泄漏 | 连接耗尽 | 连接池 + 正确关闭 |
| 任务死锁 | 任务卡住 | 超时机制 |
| 并发任务过多 | 性能下降 | 并发限制 |

## Notes
- 未来可以考虑使用 Celery + Redis（如果需要更复杂的任务调度）
- 当前轻量级设计适合 MVP 阶段
- 考虑添加任务优先级（Phase 2）

## File List
### 新增文件
- `server/src/models/async_task.py` - 任务模型
- `server/src/services/task_manager.py` - 任务管理器
- `server/src/services/task_executor.py` - 任务执行器
- `server/src/services/task_handlers.py` - 任务处理器
- `server/src/api/admin/tasks.py` - 任务 API 端点
- `server/alembic/versions/2025_12_25_0154-d1acc16dd4ad_create_async_tasks_tables.py` - 数据库迁移
- `server/tests/test_task_system.py` - 任务系统测试
- `web/src/hooks/useTaskStatus.ts` - 任务状态 Hook

### 修改文件
- `server/main.py` - 启动后台线程
- `server/src/models/__init__.py` - 添加任务模型
- `server/src/api/v1/__init__.py` - 注册任务路由
- `web/src/lib/api.ts` - 添加任务 API 客户端
- `web/src/hooks/index.ts` - 导出任务状态 Hook

---
*Created: 2025-12-24*
*Author: PM Agent (John)*
*Priority: P0*
*Estimate: 4 天*
