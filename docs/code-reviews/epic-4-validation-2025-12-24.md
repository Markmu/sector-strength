# Epic-4 æ•…äº‹éªŒè¯æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-24
**éªŒè¯èŒƒå›´**: Story 4-1, 4-2, 4-3, 4-4
**éªŒè¯è€…**: Scrum Master Agent (ç‹¬ç«‹ä¸Šä¸‹æ–‡)

---

## æ‰§è¡Œæ‘˜è¦

**æ€»ä½“è¯„ä¼°**: âš ï¸ **å‘ç°å¤šä¸ªå…³é”®é—®é¢˜éœ€è¦ä¿®å¤**

- **å…³é”®é—®é¢˜**: 8 ä¸ªï¼ˆå¿…é¡»ä¿®å¤ï¼‰
- **å¢å¼ºå»ºè®®**: 5 ä¸ªï¼ˆåº”è¯¥æ·»åŠ ï¼‰
- **ä¼˜åŒ–æœºä¼š**: 4 ä¸ªï¼ˆå¯é€‰ï¼‰

---

## ğŸš¨ å…³é”®é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### 1. æŠ€æœ¯æ ˆå†²çª - çŠ¶æ€ç®¡ç†

**é—®é¢˜**: æ•…äº‹æŒ‡å®šä½¿ç”¨ **Zustand**ï¼Œå®é™…é¡¹ç›®ä½¿ç”¨ **Redux Toolkit**

**å½±å“**:
- å¼€å‘è€…ä¼šå›°æƒ‘ä½¿ç”¨å“ªä¸ªçŠ¶æ€ç®¡ç†åº“
- å·²æœ‰è®¤è¯ç³»ç»Ÿä½¿ç”¨ Reduxï¼Œå¼•å…¥ Zustand ä¼šå¯¼è‡´åŒçŠ¶æ€ç®¡ç†

**è¯æ®**:
- `web/package.json:12` - `"@reduxjs/toolkit": "^2.11.0"`
- `web/package.json:17` - `"react-redux": "^9.2.0"`
- Story 4-1, 4-2, 4-3, 4-4 éƒ½æåˆ° "ä½¿ç”¨ Zustand"

**å»ºè®®ä¿®å¤**:
**é€‰é¡¹ A** (æ¨è): ä¿®æ”¹æ‰€æœ‰æ•…äº‹ï¼Œä½¿ç”¨ Redux Toolkit æ›¿ä»£ Zustand
**é€‰é¡¹ B**: ç§»é™¤ Reduxï¼Œæ”¹ç”¨ Zustandï¼ˆä¼šç ´åå·²æœ‰è®¤è¯åŠŸèƒ½ï¼‰

---

### 2. æŠ€æœ¯æ ˆç‰ˆæœ¬ä¸ä¸€è‡´

**é—®é¢˜**: æ•…äº‹ä¸­çš„ç‰ˆæœ¬ä¸å®é™…ä¸ç¬¦

| ç»„ä»¶ | æ•…äº‹ç‰ˆæœ¬ | å®é™…ç‰ˆæœ¬ |
|------|----------|----------|
| Next.js | 14.x | 16.0.7 |
| React | 18.x | 19.2.0 |

**å½±å“**:
- å¼€å‘è€…å¯èƒ½å®‰è£…é”™è¯¯ç‰ˆæœ¬çš„ä¾èµ–
- API å·®å¼‚å¯èƒ½å¯¼è‡´å®ç°é”™è¯¯

**å»ºè®®ä¿®å¤**: æ›´æ–°æ‰€æœ‰æ•…äº‹ä¸­çš„ç‰ˆæœ¬å·ä»¥åŒ¹é…å®é™…ç‰ˆæœ¬

---

### 3. ç¼ºå¤±ä¾èµ–åŒ…

**é—®é¢˜**: æ•…äº‹ä¸­ä½¿ç”¨çš„åº“åœ¨ `package.json` ä¸­ä¸å­˜åœ¨

**ç¼ºå¤±åº“**:
- `shadcn/ui` - å¤§é‡ UI ç»„ä»¶ä¾èµ–
- `echarts` - çƒ­åŠ›å›¾å’Œä»ªè¡¨ç›˜å¯è§†åŒ–
- `echarts-for-react` - ECharts React åŒ…è£…å™¨
- `react-window` - è™šæ‹Ÿæ»šåŠ¨
- `SWR` æˆ– `React Query` - æ•°æ®è·å–å’Œç¼“å­˜

**å½±å“**:
- å¼€å‘è€…æ— æ³•ç›´æ¥å¼€å§‹å¼€å‘
- éœ€è¦å…ˆå®‰è£…æ‰€æœ‰ç¼ºå¤±ä¾èµ–

**å»ºè®®ä¿®å¤**:
åœ¨ Story 4-1 ä¸­æ·»åŠ  **å‰ç½®ä»»åŠ¡**ï¼šå®‰è£…æ‰€æœ‰å¿…éœ€çš„ä¾èµ–åŒ…

```bash
# å¿…éœ€çš„ä¾èµ–
npm install echarts echarts-for-react react-window swr

# shadcn/ui ç»„ä»¶éœ€è¦åˆå§‹åŒ–
npx shadcn-ui@latest init
npx shadcn-ui@latest add card button badge dialog table navigation-menu
```

---

### 4. API æ•°æ®ç»“æ„ä¸åŒ¹é… - çƒ­åŠ›å›¾

**é—®é¢˜**: Story 4-2 æœŸæœ›çš„ API å“åº”ä¸å®é™…å®ç°ä¸ä¸€è‡´

**Story 4-2 æœŸæœ›**:
```typescript
{
  "sectors": [{
    "sectorId": "string",
    "sectorName": "string",
    "sectorCode": "string",
    "strengthScore": number,
    "changePercent": number,
    "marketCap": number,
    "stockCount": number
  }],
  "updated_at": "ISO8601 timestamp"
}
```

**å®é™… API è¿”å›** (`server/src/api/v1/heatmap.py:92`):
```python
{
  "success": true,
  "data": {
    "sectors": [{
      "id": "string",
      "name": "string",
      "value": number,
      "color": "hex"
    }],
    "timestamp": "datetime"
  }
}
```

**å·®å¼‚**:
1. å­—æ®µåä¸åŒ¹é…ï¼ˆcamelCase vs åç«¯ snake_caseï¼‰
2. ç¼ºå¤± `sectorCode`, `changePercent`, `marketCap`, `stockCount`
3. é¢å¤–åŒ…è£… `success` å’Œ `data` å­—æ®µ
4. åç«¯è¿”å› `color`ï¼Œå‰ç«¯åº”è¯¥è‡ªå·±è®¡ç®—

**å»ºè®®ä¿®å¤**:
**é€‰é¡¹ A** (æ¨è): ä¿®æ”¹æ•…äº‹ä»¥åŒ¹é…å®é™… API
**é€‰é¡¹ B**: ä¿®æ”¹åç«¯ API ä»¥åŒ¹é…æ•…äº‹æœŸæœ›

---

### 5. API æ•°æ®ç»“æ„ä¸åŒ¹é… - æ’å

**é—®é¢˜**: Story 4-3 æœŸæœ›çš„ API å“åº”ä¸å®é™…å®ç°ä¸ä¸€è‡´

**Story 4-3 æœŸæœ›**:
```typescript
{
  "sectors": [{
    "sectorId": "string",
    "sectorName": "string",
    "sectorCode": "string",
    "strengthScore": number,
    "changePercent": number,
    "marketCap": number,
    "rank": number
  }],
  "updated_at": "ISO8601 timestamp"
}
```

**å®é™… API è¿”å›** (`server/src/api/v1/rankings.py:79`):
```python
{
  "success": true,
  "data": [{
    "id": "string",
    "name": "string",
    "code": "string",
    "strength_score": number,
    "trend_direction": number,
    "rank": number
  }],
  "total": number,
  "top_n": number
}
```

**å·®å¼‚**:
1. å­—æ®µåä¸åŒ¹é…ï¼ˆ`strengthScore` vs `strength_score`ï¼‰
2. ç¼ºå¤± `changePercent`, `marketCap`
3. é¢å¤– `trend_direction` å­—æ®µï¼ˆæ•…äº‹ä¸­æ²¡ç”¨åˆ°ï¼‰
4. ç¼ºå¤± `rankChange` å­—æ®µï¼ˆæ’åå˜åŒ–æŒ‡ç¤ºå™¨éœ€è¦ï¼‰

**å»ºè®®ä¿®å¤**:
ä¿®æ”¹æ•…äº‹ä»¥åŒ¹é…å®é™… APIï¼Œæˆ–è€…åœ¨åç«¯æ·»åŠ ç¼ºå¤±å­—æ®µ

---

### 6. ç¼ºå¤±å¸‚åœºæŒ‡æ•° API

**é—®é¢˜**: Story 4-4 éœ€è¦çš„ `/api/market-index` ç«¯ç‚¹**å®Œå…¨ä¸å­˜åœ¨**

**Story 4-4 æœŸæœ›**:
```
GET /api/market-index
Response: {
  "index": { "value": 68.5, "change": 2.3, ... },
  "stats": { "totalSectors": 45, ... },
  "trend": [...]
}
```

**å®é™…æƒ…å†µ**:
- åç«¯ `server/src/api/v1/` ç›®å½•**æ²¡æœ‰** `market_index.py` æˆ–ç±»ä¼¼æ–‡ä»¶
- æœç´¢ `market-index|market_index` è¿”å› 0 ç»“æœ

**å½±å“**: Story 4-4 **æ— æ³•å®ç°**ï¼Œå¿…é¡»å…ˆåˆ›å»ºåç«¯ API

**å»ºè®®ä¿®å¤**:
**å¿…é¡»å…ˆåˆ›å»º Story**: "å®ç°å¸‚åœºæŒ‡æ•°è®¡ç®—å’Œ API ç«¯ç‚¹"
- æ·»åŠ åˆ° Epic 3 æˆ–åˆ›å»ºæ–°çš„å‰ç½®æ•…äº‹
- è®¡ç®—åŠ æƒå¹³å‡å¸‚åœºæŒ‡æ•°
- ç»Ÿè®¡ä¸Šæ¶¨/ä¸‹è·Œæ¿å—æ•°é‡
- è¿”å›å†å²è¶‹åŠ¿æ•°æ®

---

### 7. æ’åå˜åŒ–æŒ‡ç¤ºå™¨æ— æ³•å®ç°

**é—®é¢˜**: Story 4-3 è¦æ±‚æ’åå˜åŒ–æŒ‡ç¤ºå™¨ï¼ˆâ†‘â†“ï¼‰ï¼Œä½† API ä¸æ”¯æŒ

**Story 4-3 è¦æ±‚**:
- AC 9: "æ·»åŠ å˜åŒ–æŒ‡ç¤ºå™¨ï¼ˆä¸Šå‡â†‘ã€ä¸‹é™â†“ã€æŒå¹³-ï¼‰"
- ä»»åŠ¡: "æ·»åŠ æ’åå˜åŒ–æŒ‡ç¤ºå™¨ï¼ˆä¸ä¸Šæ¬¡åˆ·æ–°å¯¹æ¯”ï¼‰"

**é—®é¢˜**:
- API ä¸è¿”å› `rankChange` å­—æ®µ
- æ²¡æœ‰å†å²æ’åæ•°æ®ç”¨äºå¯¹æ¯”
- å‰ç«¯æ— æ³•è®¡ç®—æ’åå˜åŒ–

**å»ºè®®ä¿®å¤**:
**é€‰é¡¹ A**: ç§»é™¤æ­¤ ACï¼ˆç®€åŒ–æ•…äº‹ï¼‰
**é€‰é¡¹ B**: æ·»åŠ åç«¯æ”¯æŒï¼ˆéœ€è¦ä¿®æ”¹æ•°æ®æ¨¡å‹å­˜å‚¨å†å²æ’åï¼‰

---

### 8. é¢œè‰²ç¼–ç ä¸ä¸€è‡´

**é—®é¢˜**: ä¸åŒæ•…äº‹ä½¿ç”¨ä¸åŒçš„é¢œè‰²æ–¹æ¡ˆ

**Story 4-2 çƒ­åŠ›å›¾** (5 çº§):
```
0-30: çº¢è‰²
30-50: æ©™è‰²
50-70: é»„è‰²
70-90: æµ…ç»¿
90-100: æ·±ç»¿
```

**Story 4-4 æŒ‡æ•°** (3 çº§):
```
0-40: çº¢è‰² (å¼±)
40-70: é»„è‰² (ä¸­)
70-100: ç»¿è‰² (å¼º)
```

**åç«¯å®ç°** (`heatmap.py:33-46`) (7 çº§):
```
>=80: ç»¿è‰²
65-80: æµ…ç»¿
50-65: é»„è‰²
35-50: ç°è‰²
20-35: æ©™è‰²
10-20: æµ…çº¢
<10: çº¢è‰²
```

**å½±å“**: ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´ï¼Œè§†è§‰æ··ä¹±

**å»ºè®®ä¿®å¤**:
åˆ›å»ºç»Ÿä¸€çš„é¢œè‰²ç¼–ç æ ‡å‡†æ–‡ä»¶ï¼Œæ‰€æœ‰æ•…äº‹å¼•ç”¨åŒä¸€æ ‡å‡†

---

## âš¡ å¢å¼ºå»ºè®®ï¼ˆåº”è¯¥æ·»åŠ ï¼‰

### 1. æ·»åŠ å‰ç«¯é¡¹ç›®ç»“æ„ç¡®è®¤

**å»ºè®®**: åœ¨ Story 4-1 å¼€å¤´æ·»åŠ ï¼š

```markdown
### å‰ç½®æ£€æŸ¥

æ‰§è¡Œå‰ç¡®è®¤ï¼š
- [ ] `web/src/app/` ç›®å½•å­˜åœ¨
- [ ] Next.js 16.x å·²å®‰è£…
- [ ] æ‰€æœ‰å¿…éœ€ä¾èµ–å·²å®‰è£…ï¼ˆè§"å®‰è£…ä¾èµ–"ä»»åŠ¡ï¼‰
```

---

### 2. æ·»åŠ å…·ä½“è·¯ç”±é…ç½®ç¤ºä¾‹

**å»ºè®®**: åœ¨ Story 4-1 çš„ä»»åŠ¡ä¸­æ·»åŠ ä»£ç ç¤ºä¾‹ï¼š

```typescript
// web/src/app/dashboard/page.tsx
import { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'ä»ªè¡¨æ¿ | Sector Strength',
  description: 'æ¿å—å¼ºåº¦åˆ†æä»ªè¡¨æ¿',
};

export default function DashboardPage() {
  return (
    <div className="container mx-auto py-6">
      <DashboardLayout />
    </div>
  );
}
```

---

### 3. æ·»åŠ  shadcn/ui åˆå§‹åŒ–è¯´æ˜

**å»ºè®®**: Story 4-1 éœ€è¦è¯´æ˜ shadcn/ui æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š

```markdown
### shadcn/ui é›†æˆè¯´æ˜

shadcn/ui ä¸æ˜¯ä¸€ä¸ª npm åŒ…ï¼Œè€Œæ˜¯ä¸€ä¸ªç»„ä»¶é›†åˆï¼š
1. é¦–å…ˆè¿è¡Œ `npx shadcn-ui@latest init` åˆå§‹åŒ–
2. ç„¶åè¿è¡Œ `npx shadcn-ui@latest add <component-name>` æ·»åŠ ç»„ä»¶
3. ç»„ä»¶ä¼šè¢«æ·»åŠ åˆ° `web/src/components/ui/` ç›®å½•
```

---

### 4. æ·»åŠ æ•°æ®ç¼“å­˜ç­–ç•¥è¯´æ˜

**å»ºè®®**: æ‰€æœ‰æ•°æ®è·å–æ•…äº‹éƒ½åº”è¯¥è¯´æ˜ç¼“å­˜ç­–ç•¥ï¼š

```markdown
### SWR ç¼“å­˜é…ç½®

```typescript
useSWR('/api/heatmap', fetcher, {
  refreshInterval: 5000,  // 5 ç§’è‡ªåŠ¨åˆ·æ–°
  revalidateOnFocus: true,
  revalidateOnReconnect: true,
  dedupingInterval: 2000,  // 2 ç§’å†…å»é‡è¯·æ±‚
});
```
```

---

### 5. æ·»åŠ é”™è¯¯å¤„ç†æ¨¡å¼

**å»ºè®®**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å¼ç¤ºä¾‹ï¼š

```typescript
const { data, error, isLoading } = useSWR('/api/heatmap', fetcher);

if (error) {
  return <ErrorState message="æ— æ³•åŠ è½½çƒ­åŠ›å›¾æ•°æ®" />;
}
if (isLoading) {
  return <SkeletonHeatmap />;
}
```

---

## âœ¨ ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰ï¼‰

### 1. TypeScript æ¥å£å®šä¹‰å¯ä»¥ç»Ÿä¸€

**å»ºè®®**: åˆ›å»ºå…±äº«ç±»å‹æ–‡ä»¶å‡å°‘é‡å¤

---

### 2. ECharts é…ç½®å¯ä»¥æä¾›æ›´å¤šä¸»é¢˜é€‰é¡¹

**å»ºè®®**: æ·»åŠ æ·±è‰²/æµ…è‰²ä¸»é¢˜é…ç½®

---

### 3. æ·»åŠ æ€§èƒ½ç›‘æ§

**å»ºè®®**: æ·»åŠ  Web Vitals ç›‘æ§ï¼ˆNFR1 < 200msï¼‰

---

### 4. æ·»åŠ æ— éšœç¢æ”¯æŒ

**å»ºè®®**: çƒ­åŠ›å›¾å’Œåˆ—è¡¨æ·»åŠ  ARIA æ ‡ç­¾

---

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ | å½±å“æ•…äº‹ |
|--------|------|----------|
| P0 - ç«‹å³ä¿®å¤ | ç¼ºå¤±å¸‚åœºæŒ‡æ•° API (#6) | 4-4 |
| P0 - ç«‹å³ä¿®å¤ | æŠ€æœ¯æ ˆå†²çª (#1) | å…¨éƒ¨ |
| P1 - å°½å¿«ä¿®å¤ | ç¼ºå¤±ä¾èµ–åŒ… (#3) | å…¨éƒ¨ |
| P1 - å°½å¿«ä¿®å¤ | API æ•°æ®ç»“æ„ä¸åŒ¹é… (#4, #5) | 4-2, 4-3 |
| P2 - åº”è¯¥ä¿®å¤ | ç‰ˆæœ¬ä¸ä¸€è‡´ (#2) | å…¨éƒ¨ |
| P2 - åº”è¯¥ä¿®å¤ | æ’åå˜åŒ–æŒ‡ç¤ºå™¨ (#7) | 4-3 |
| P3 - å¯ä»¥å»¶å | é¢œè‰²ç¼–ç ä¸ä¸€è‡´ (#8) | 4-2, 4-4 |

---

## ğŸ¯ æ¨èè¡ŒåŠ¨è®¡åˆ’

### é˜¶æ®µ 1: ç«‹å³ä¿®å¤ï¼ˆé˜»å¡å¼€å‘ï¼‰

1. **ä¿®å¤æŠ€æœ¯æ ˆå†²çª**: æ›´æ–°æ‰€æœ‰æ•…äº‹ï¼Œä½¿ç”¨ Redux Toolkit æ›¿ä»£ Zustand
2. **åˆ›å»ºå¸‚åœºæŒ‡æ•° API**: æ·»åŠ æ–°çš„æ•…äº‹æˆ–ä¿®æ”¹ Epic 3
3. **æ›´æ–°ç‰ˆæœ¬å·**: æ‰€æœ‰æ•…äº‹æ”¹ä¸º Next.js 16.x, React 19.x

### é˜¶æ®µ 2: å¿«é€Ÿä¿®å¤ï¼ˆå½±å“è´¨é‡ï¼‰

4. **æ·»åŠ ä¾èµ–å®‰è£…ä»»åŠ¡**: åœ¨ Story 4-1 æ·»åŠ  npm install ä»»åŠ¡
5. **ä¿®å¤ API æ•°æ®ç»“æ„**: æ›´æ–°å‰ç«¯æœŸæœ›ä»¥åŒ¹é…å®é™… API
6. **ç§»é™¤ä¸å¯è¡ŒåŠŸèƒ½**: ç§»é™¤æ’åå˜åŒ–æŒ‡ç¤ºå™¨æˆ–åˆ›å»ºåç«¯æ”¯æŒ

### é˜¶æ®µ 3: è´¨é‡æå‡ï¼ˆå¯é€‰ï¼‰

7. **ç»Ÿä¸€é¢œè‰²ç¼–ç **: åˆ›å»ºå…±äº«é¢œè‰²å¸¸é‡æ–‡ä»¶
8. **æ·»åŠ å®ç°ç¤ºä¾‹**: æ·»åŠ æ›´å¤šä»£ç ç¤ºä¾‹

---

## æ€»ç»“

Epic-4 çš„æ•…äº‹æ•´ä½“ç»“æ„è‰¯å¥½ï¼Œä½†å­˜åœ¨ä»¥ä¸‹**å¿…é¡»ä¿®å¤**çš„é—®é¢˜ï¼š

1. **æŠ€æœ¯æ ˆä¸å®é™…ä¸ç¬¦** - Redux vs Zustand
2. **API å¥‘çº¦ä¸æ˜ç¡®** - å‰åç«¯æ•°æ®ç»“æ„ä¸åŒ¹é…
3. **ç¼ºå¤±å…³é”® API** - å¸‚åœºæŒ‡æ•°ç«¯ç‚¹ä¸å­˜åœ¨
4. **ä¾èµ–åŒ…æœªè¯´æ˜** - éœ€è¦å…ˆå®‰è£…æ‰èƒ½å¼€å‘

**å»ºè®®**: åœ¨å¼€å§‹å¼€å‘å‰ï¼Œè¯·ä¼˜å…ˆä¿®å¤ P0 å’Œ P1 çº§åˆ«é—®é¢˜ã€‚

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2025-12-24*
*éªŒè¯å·¥å…·: BMad validate-workflow*
