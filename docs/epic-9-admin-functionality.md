# Epic 9: 管理员功能系统

## Status
Ready for Development

## Overview
实现完整的管理员数据管理系统，包括角色权限控制、数据初始化、数据更新补齐、异步任务管理、管理员界面和操作审计。本系统使管理员能够维护股票和板块数据的准确性和完整性，同时确保所有操作可追溯。

## Business Value
- **数据维护效率**：管理员可以快速初始化和更新数据，减少手动操作时间 90%
- **数据质量保证**：通过数据覆盖和补齐功能，确保系统数据始终准确
- **系统可靠性**：异步任务系统确保大数据量操作不会阻塞用户界面
- **操作透明度**：完整的审计日志支持问题追溯和合规要求

## Epic Goals
1. 实现基于角色的访问控制（RBAC），确保只有管理员能访问管理功能
2. 提供灵活的数据初始化功能，支持自定义时间范围和覆盖选项
3. 支持按日期补齐和按时间段拉取历史数据
4. 构建轻量级异步任务系统，在 FastAPI 进程内运行后台线程
5. 创建直观的管理员界面，实时显示任务进度和状态
6. 记录所有管理员操作，支持审计和追溯

## User Stories
- **Story 9.1**: 管理员角色和权限（RBAC）
- **Story 9.2**: 数据初始化功能
- **Story 9.3**: 数据更新和补齐
- **Story 9.4**: 异步任务系统
- **Story 9.5**: 管理员界面
- **Story 9.6**: 操作审计日志

## Dependencies
- **依赖 Epic 1**: 基础设施和数据库（用户表、任务表、审计表）
- **依赖 Epic 2**: 用户认证系统（JWT、角色识别）
- **并行开发**: 可与 Epic 3、4 并行开发（独立的管理功能模块）

## Functional Requirements Covered
| FR | 描述 | Story |
|----|------|-------|
| FR5 | 系统可以区分普通用户和管理员角色 | 9.1 |
| FR6 | 管理员可以访问数据管理功能 | 9.1 |
| FR7 | 非管理员用户无法访问管理员功能 | 9.1 |
| FR26 | 管理员可以初始化所有板块数据 | 9.2 |
| FR27 | 管理员可以自定义数据回溯时间范围 | 9.2 |
| FR28 | 管理员可以初始化所有股票数据 | 9.2 |
| FR29 | 管理员可以按日期补齐数据 | 9.3 |
| FR30 | 管理员可以按时间段拉取历史数据 | 9.3 |
| FR31 | 管理员可以选择覆盖已有数据 | 9.3 |
| FR32 | 系统可以异步执行数据初始化任务 | 9.4 |
| FR33 | 系统可以显示数据任务的实时进度 | 9.4, 9.5 |
| FR34 | 系统可以显示任务状态（成功/失败/进行中） | 9.4, 9.5 |
| FR35 | 管理员可以查看任务操作日志 | 9.5 |
| FR36 | 系统可以记录所有管理员的操作到审计日志 | 9.6 |
| FR37 | 系统支持任务失败后自动重试 | 9.4 |

## Non-Functional Requirements
| NFR | 描述 | Story |
|-----|------|-------|
| NFR-SEC-003 | 管理员功能必须有 RBAC | 9.1 |
| NFR-SEC-004 | 非管理员无法访问管理员功能 | 9.1 |
| NFR-SEC-008 | 记录所有管理员操作到审计日志 | 9.6 |
| NFR-SEC-009 | 审计日志包含操作人、时间、操作内容、IP | 9.6 |
| NFR-SEC-010 | 审计日志保留至少 6 个月 | 9.6 |
| NFR-REL-003 | 数据初始化任务成功率 > 95% | 9.4 |
| NFR-SCALE-009 | 后台任务应有重试机制和超时控制 | 9.4 |

## Acceptance Criteria (Epic Level)
1. ✅ 系统能够区分普通用户和管理员角色
2. ✅ 只有管理员用户能访问管理功能（/admin/* 路由）
3. ✅ 管理员可以初始化板块和股票数据，支持自定义时间范围
4. ✅ 管理员可以按日期补齐数据和按时间段拉取历史数据
5. ✅ 管理员可以选择是否覆盖已有数据
6. ✅ 数据任务异步执行，不阻塞用户界面
7. ✅ 任务进度实时更新，显示百分比和当前状态
8. ✅ 任务失败后自动重试（最多 3 次）
9. ✅ 管理员界面显示任务列表、状态、日志
10. ✅ 所有管理员操作记录到审计日志
11. ✅ 审计日志支持查询和导出

## Technical Approach
### 数据库表设计
- `users` 表：添加 `role` 字段（user/admin）
- `async_tasks` 表：任务状态、进度、错误信息
- `audit_logs` 表：操作人、时间、操作内容、IP 地址、结果

### 异步任务架构
- 基于数据库的任务队列（PostgreSQL 存储任务状态）
- 后台线程在 FastAPI 进程内运行
- 轮询间隔：1 秒
- 任务状态：pending, running, completed, failed, cancelled

### 管理员界面
- React 组件：DataInitPanel, TaskMonitorPanel, UserManagePanel
- WebSocket 或轮询：实时任务进度更新
- shadcn/ui 组件：Card, Button, Progress, Table

## Definition of Done
- [ ] 所有 Story 的验收标准完成
- [ ] 代码审查通过
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] API 文档更新
- [ ] 管理员操作手册完成
- [ ] 性能测试通过（1000 个任务并发）

## Risk Assessment
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| AkShare API 限流 | 数据初始化失败 | 实现请求间隔和重试机制 |
| 后台线程资源占用 | 影响主服务性能 | 设置任务并发上限和超时 |
| 数据库连接泄漏 | 系统不稳定 | 使用连接池，正确关闭连接 |
| 权限配置错误 | 安全漏洞 | 完整的权限测试和代码审查 |

## Stories Summary
| Story | 描述 | 优先级 | 估算 |
|-------|------|--------|------|
| 9.1 | 管理员角色和权限（RBAC） | P0 | 2 天 |
| 9.2 | 数据初始化功能 | P0 | 3 天 |
| 9.3 | 数据更新和补齐 | P0 | 2 天 |
| 9.4 | 异步任务系统 | P0 | 4 天 |
| 9.5 | 管理员界面 | P1 | 3 天 |
| 9.6 | 操作审计日志 | P1 | 2 天 |

**总计估算：16 天（约 3 周）**

## Notes
- 异步任务系统采用轻量级设计，无需 Redis 或独立 Worker
- 所有管理员操作必须记录审计日志，用于合规追溯
- 数据初始化功能应支持取消操作，避免长时间运行
- 考虑未来扩展：支持定时任务调度（Phase 2）

---
*Created: 2025-12-24*
*Author: PM Agent (John)*
*Last Updated: 2025-12-24*
